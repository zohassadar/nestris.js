// pngjs2 original work Copyright (c) 2015 Luke Page & Original Contributors
// pngjs derived work Copyright (c) 2012 Kuba Niegowski

// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:

// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

var Qe=Object.create;var q=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var Xe=Object.getOwnPropertyNames;var et=Object.getPrototypeOf,tt=Object.prototype.hasOwnProperty;var m=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Y=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of Xe(t))!tt.call(e,l)&&l!==i&&q(e,l,{get:()=>t[l],enumerable:!(r=$e(t,l))||r.enumerable});return e},N=(e,t,i)=>(Y(e,t,"default"),i&&Y(i,t,"default")),it=(e,t,i)=>(i=e!=null?Qe(et(e)):{},Y(t||!e||!e.__esModule?q(i,"default",{value:e,enumerable:!0}):i,e)),rt=e=>Y(q({},"__esModule",{value:!0}),e);var U=m((oi,te)=>{"use strict";var nt=require("util"),ee=require("stream"),L=te.exports=function(){ee.call(this),this._buffers=[],this._buffered=0,this._reads=[],this._paused=!1,this._encoding="utf8",this.writable=!0};nt.inherits(L,ee);L.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t}),process.nextTick(function(){this._process(),this._paused&&this._reads&&this._reads.length>0&&(this._paused=!1,this.emit("drain"))}.bind(this))};L.prototype.write=function(e,t){if(!this.writable)return this.emit("error",new Error("Stream not writable")),!1;let i;return Buffer.isBuffer(e)?i=e:i=Buffer.from(e,t||this._encoding),this._buffers.push(i),this._buffered+=i.length,this._process(),this._reads&&this._reads.length===0&&(this._paused=!0),this.writable&&!this._paused};L.prototype.end=function(e,t){e&&this.write(e,t),this.writable=!1,this._buffers&&(this._buffers.length===0?this._end():(this._buffers.push(null),this._process()))};L.prototype.destroySoon=L.prototype.end;L.prototype._end=function(){this._reads.length>0&&this.emit("error",new Error("Unexpected end of input")),this.destroy()};L.prototype.destroy=function(){!this._buffers||(this.writable=!1,this._reads=null,this._buffers=null,this.emit("close"))};L.prototype._processReadAllowingLess=function(e){this._reads.shift();let t=this._buffers[0];t.length>e.length?(this._buffered-=e.length,this._buffers[0]=t.slice(e.length),e.func.call(this,t.slice(0,e.length))):(this._buffered-=t.length,this._buffers.shift(),e.func.call(this,t))};L.prototype._processRead=function(e){this._reads.shift();let t=0,i=0,r=Buffer.alloc(e.length);for(;t<e.length;){let l=this._buffers[i++],n=Math.min(l.length,e.length-t);l.copy(r,t,0,n),t+=n,n!==l.length&&(this._buffers[--i]=l.slice(n))}i>0&&this._buffers.splice(0,i),this._buffered-=e.length,e.func.call(this,r)};L.prototype._process=function(){try{for(;this._buffered>0&&this._reads&&this._reads.length>0;){let e=this._reads[0];if(e.allowLess)this._processReadAllowingLess(e);else if(this._buffered>=e.length)this._processRead(e);else break}this._buffers&&!this.writable&&this._end()}catch(e){this.emit("error",e)}}});var D=m(H=>{"use strict";var k=[{x:[0],y:[0]},{x:[4],y:[0]},{x:[0,4],y:[4]},{x:[2,6],y:[0,4]},{x:[0,2,4,6],y:[2,6]},{x:[1,3,5,7],y:[0,2,4,6]},{x:[0,1,2,3,4,5,6,7],y:[1,3,5,7]}];H.getImagePasses=function(e,t){let i=[],r=e%8,l=t%8,n=(e-r)/8,s=(t-l)/8;for(let h=0;h<k.length;h++){let f=k[h],o=n*f.x.length,a=s*f.y.length;for(let u=0;u<f.x.length&&f.x[u]<r;u++)o++;for(let u=0;u<f.y.length&&f.y[u]<l;u++)a++;o>0&&a>0&&i.push({width:o,height:a,index:h})}return i};H.getInterlaceIterator=function(e){return function(t,i,r){let l=t%k[r].x.length,n=(t-l)/k[r].x.length*8+k[r].x[l],s=i%k[r].y.length,h=(i-s)/k[r].y.length*8+k[r].y[s];return n*4+h*e*4}}});var v=m((ui,ie)=>{"use strict";ie.exports=function(t,i,r){let l=t+i-r,n=Math.abs(l-t),s=Math.abs(l-i),h=Math.abs(l-r);return n<=s&&n<=h?t:s<=h?i:r}});var G=m((ci,ne)=>{"use strict";var lt=D(),st=v();function re(e,t,i){let r=e*t;return i!==8&&(r=Math.ceil(r/(8/i))),r}var B=ne.exports=function(e,t){let i=e.width,r=e.height,l=e.interlace,n=e.bpp,s=e.depth;if(this.read=t.read,this.write=t.write,this.complete=t.complete,this._imageIndex=0,this._images=[],l){let h=lt.getImagePasses(i,r);for(let f=0;f<h.length;f++)this._images.push({byteWidth:re(h[f].width,n,s),height:h[f].height,lineIndex:0})}else this._images.push({byteWidth:re(i,n,s),height:r,lineIndex:0});s===8?this._xComparison=n:s===16?this._xComparison=n*2:this._xComparison=1};B.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))};B.prototype._unFilterType1=function(e,t,i){let r=this._xComparison,l=r-1;for(let n=0;n<i;n++){let s=e[1+n],h=n>l?t[n-r]:0;t[n]=s+h}};B.prototype._unFilterType2=function(e,t,i){let r=this._lastLine;for(let l=0;l<i;l++){let n=e[1+l],s=r?r[l]:0;t[l]=n+s}};B.prototype._unFilterType3=function(e,t,i){let r=this._xComparison,l=r-1,n=this._lastLine;for(let s=0;s<i;s++){let h=e[1+s],f=n?n[s]:0,o=s>l?t[s-r]:0,a=Math.floor((o+f)/2);t[s]=h+a}};B.prototype._unFilterType4=function(e,t,i){let r=this._xComparison,l=r-1,n=this._lastLine;for(let s=0;s<i;s++){let h=e[1+s],f=n?n[s]:0,o=s>l?t[s-r]:0,a=s>l&&n?n[s-r]:0,u=st(o,f,a);t[s]=h+u}};B.prototype._reverseFilterLine=function(e){let t=e[0],i,r=this._images[this._imageIndex],l=r.byteWidth;if(t===0)i=e.slice(1,l+1);else switch(i=Buffer.alloc(l),t){case 1:this._unFilterType1(e,i,l);break;case 2:this._unFilterType2(e,i,l);break;case 3:this._unFilterType3(e,i,l);break;case 4:this._unFilterType4(e,i,l);break;default:throw new Error("Unrecognised filter type - "+t)}this.write(i),r.lineIndex++,r.lineIndex>=r.height?(this._lastLine=null,this._imageIndex++,r=this._images[this._imageIndex]):this._lastLine=i,r?this.read(r.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())}});var he=m((_i,se)=>{"use strict";var ht=require("util"),le=U(),ft=G(),ot=se.exports=function(e){le.call(this);let t=[],i=this;this._filter=new ft(e,{read:this.read.bind(this),write:function(r){t.push(r)},complete:function(){i.emit("complete",Buffer.concat(t))}}),this._filter.start()};ht.inherits(ot,le)});var P=m((pi,fe)=>{"use strict";fe.exports={PNG_SIGNATURE:[137,80,78,71,13,10,26,10],TYPE_IHDR:1229472850,TYPE_IEND:1229278788,TYPE_IDAT:1229209940,TYPE_PLTE:1347179589,TYPE_tRNS:1951551059,TYPE_gAMA:1732332865,COLORTYPE_GRAYSCALE:0,COLORTYPE_PALETTE:1,COLORTYPE_COLOR:2,COLORTYPE_ALPHA:4,COLORTYPE_PALETTE_COLOR:3,COLORTYPE_COLOR_ALPHA:6,COLORTYPE_TO_BPP_MAP:{0:1,2:3,3:1,4:2,6:4},GAMMA_DIVISION:1e5}});var j=m((di,oe)=>{"use strict";var F=[];(function(){for(let e=0;e<256;e++){let t=e;for(let i=0;i<8;i++)t&1?t=3988292384^t>>>1:t=t>>>1;F[e]=t}})();var z=oe.exports=function(){this._crc=-1};z.prototype.write=function(e){for(let t=0;t<e.length;t++)this._crc=F[(this._crc^e[t])&255]^this._crc>>>8;return!0};z.prototype.crc32=function(){return this._crc^-1};z.crc32=function(e){let t=-1;for(let i=0;i<e.length;i++)t=F[(t^e[i])&255]^t>>>8;return t^-1}});var Z=m((gi,ae)=>{"use strict";var b=P(),at=j(),E=ae.exports=function(e,t){this._options=e,e.checkCRC=e.checkCRC!==!1,this._hasIHDR=!1,this._hasIEND=!1,this._emittedHeadersFinished=!1,this._palette=[],this._colorType=0,this._chunks={},this._chunks[b.TYPE_IHDR]=this._handleIHDR.bind(this),this._chunks[b.TYPE_IEND]=this._handleIEND.bind(this),this._chunks[b.TYPE_IDAT]=this._handleIDAT.bind(this),this._chunks[b.TYPE_PLTE]=this._handlePLTE.bind(this),this._chunks[b.TYPE_tRNS]=this._handleTRNS.bind(this),this._chunks[b.TYPE_gAMA]=this._handleGAMA.bind(this),this.read=t.read,this.error=t.error,this.metadata=t.metadata,this.gamma=t.gamma,this.transColor=t.transColor,this.palette=t.palette,this.parsed=t.parsed,this.inflateData=t.inflateData,this.finished=t.finished,this.simpleTransparency=t.simpleTransparency,this.headersFinished=t.headersFinished||function(){}};E.prototype.start=function(){this.read(b.PNG_SIGNATURE.length,this._parseSignature.bind(this))};E.prototype._parseSignature=function(e){let t=b.PNG_SIGNATURE;for(let i=0;i<t.length;i++)if(e[i]!==t[i]){this.error(new Error("Invalid file signature"));return}this.read(8,this._parseChunkBegin.bind(this))};E.prototype._parseChunkBegin=function(e){let t=e.readUInt32BE(0),i=e.readUInt32BE(4),r="";for(let n=4;n<8;n++)r+=String.fromCharCode(e[n]);let l=Boolean(e[4]&32);if(!this._hasIHDR&&i!==b.TYPE_IHDR){this.error(new Error("Expected IHDR on beggining"));return}if(this._crc=new at,this._crc.write(Buffer.from(r)),this._chunks[i])return this._chunks[i](t);if(!l){this.error(new Error("Unsupported critical chunk type "+r));return}this.read(t+4,this._skipChunk.bind(this))};E.prototype._skipChunk=function(){this.read(8,this._parseChunkBegin.bind(this))};E.prototype._handleChunkEnd=function(){this.read(4,this._parseChunkEnd.bind(this))};E.prototype._parseChunkEnd=function(e){let t=e.readInt32BE(0),i=this._crc.crc32();if(this._options.checkCRC&&i!==t){this.error(new Error("Crc error - "+t+" - "+i));return}this._hasIEND||this.read(8,this._parseChunkBegin.bind(this))};E.prototype._handleIHDR=function(e){this.read(e,this._parseIHDR.bind(this))};E.prototype._parseIHDR=function(e){this._crc.write(e);let t=e.readUInt32BE(0),i=e.readUInt32BE(4),r=e[8],l=e[9],n=e[10],s=e[11],h=e[12];if(r!==8&&r!==4&&r!==2&&r!==1&&r!==16){this.error(new Error("Unsupported bit depth "+r));return}if(!(l in b.COLORTYPE_TO_BPP_MAP)){this.error(new Error("Unsupported color type"));return}if(n!==0){this.error(new Error("Unsupported compression method"));return}if(s!==0){this.error(new Error("Unsupported filter method"));return}if(h!==0&&h!==1){this.error(new Error("Unsupported interlace method"));return}this._colorType=l;let f=b.COLORTYPE_TO_BPP_MAP[this._colorType];this._hasIHDR=!0,this.metadata({width:t,height:i,depth:r,interlace:Boolean(h),palette:Boolean(l&b.COLORTYPE_PALETTE),color:Boolean(l&b.COLORTYPE_COLOR),alpha:Boolean(l&b.COLORTYPE_ALPHA),bpp:f,colorType:l}),this._handleChunkEnd()};E.prototype._handlePLTE=function(e){this.read(e,this._parsePLTE.bind(this))};E.prototype._parsePLTE=function(e){this._crc.write(e);let t=Math.floor(e.length/3);for(let i=0;i<t;i++)this._palette.push([e[i*3],e[i*3+1],e[i*3+2],255]);this.palette(this._palette),this._handleChunkEnd()};E.prototype._handleTRNS=function(e){this.simpleTransparency(),this.read(e,this._parseTRNS.bind(this))};E.prototype._parseTRNS=function(e){if(this._crc.write(e),this._colorType===b.COLORTYPE_PALETTE_COLOR){if(this._palette.length===0){this.error(new Error("Transparency chunk must be after palette"));return}if(e.length>this._palette.length){this.error(new Error("More transparent colors than palette size"));return}for(let t=0;t<e.length;t++)this._palette[t][3]=e[t];this.palette(this._palette)}this._colorType===b.COLORTYPE_GRAYSCALE&&this.transColor([e.readUInt16BE(0)]),this._colorType===b.COLORTYPE_COLOR&&this.transColor([e.readUInt16BE(0),e.readUInt16BE(2),e.readUInt16BE(4)]),this._handleChunkEnd()};E.prototype._handleGAMA=function(e){this.read(e,this._parseGAMA.bind(this))};E.prototype._parseGAMA=function(e){this._crc.write(e),this.gamma(e.readUInt32BE(0)/b.GAMMA_DIVISION),this._handleChunkEnd()};E.prototype._handleIDAT=function(e){this._emittedHeadersFinished||(this._emittedHeadersFinished=!0,this.headersFinished()),this.read(-e,this._parseIDAT.bind(this,e))};E.prototype._parseIDAT=function(e,t){if(this._crc.write(t),this._colorType===b.COLORTYPE_PALETTE_COLOR&&this._palette.length===0)throw new Error("Expected palette not found");this.inflateData(t);let i=e-t.length;i>0?this._handleIDAT(i):this._handleChunkEnd()};E.prototype._handleIEND=function(e){this.read(e,this._parseIEND.bind(this))};E.prototype._parseIEND=function(e){this._crc.write(e),this._hasIEND=!0,this._handleChunkEnd(),this.finished&&this.finished()}});var V=m(ce=>{"use strict";var ue=D(),ut=[function(){},function(e,t,i,r){if(r===t.length)throw new Error("Ran out of data");let l=t[r];e[i]=l,e[i+1]=l,e[i+2]=l,e[i+3]=255},function(e,t,i,r){if(r+1>=t.length)throw new Error("Ran out of data");let l=t[r];e[i]=l,e[i+1]=l,e[i+2]=l,e[i+3]=t[r+1]},function(e,t,i,r){if(r+2>=t.length)throw new Error("Ran out of data");e[i]=t[r],e[i+1]=t[r+1],e[i+2]=t[r+2],e[i+3]=255},function(e,t,i,r){if(r+3>=t.length)throw new Error("Ran out of data");e[i]=t[r],e[i+1]=t[r+1],e[i+2]=t[r+2],e[i+3]=t[r+3]}],ct=[function(){},function(e,t,i,r){let l=t[0];e[i]=l,e[i+1]=l,e[i+2]=l,e[i+3]=r},function(e,t,i){let r=t[0];e[i]=r,e[i+1]=r,e[i+2]=r,e[i+3]=t[1]},function(e,t,i,r){e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=r},function(e,t,i){e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=t[3]}];function _t(e,t){let i=[],r=0;function l(){if(r===e.length)throw new Error("Ran out of data");let n=e[r];r++;let s,h,f,o,a,u,c,p;switch(t){default:throw new Error("unrecognised depth");case 16:c=e[r],r++,i.push((n<<8)+c);break;case 4:c=n&15,p=n>>4,i.push(p,c);break;case 2:a=n&3,u=n>>2&3,c=n>>4&3,p=n>>6&3,i.push(p,c,u,a);break;case 1:s=n&1,h=n>>1&1,f=n>>2&1,o=n>>3&1,a=n>>4&1,u=n>>5&1,c=n>>6&1,p=n>>7&1,i.push(p,c,u,a,o,f,h,s);break}}return{get:function(n){for(;i.length<n;)l();let s=i.slice(0,n);return i=i.slice(n),s},resetAfterLine:function(){i.length=0},end:function(){if(r!==e.length)throw new Error("extra data found")}}}function pt(e,t,i,r,l,n){let s=e.width,h=e.height,f=e.index;for(let o=0;o<h;o++)for(let a=0;a<s;a++){let u=i(a,o,f);ut[r](t,l,u,n),n+=r}return n}function dt(e,t,i,r,l,n){let s=e.width,h=e.height,f=e.index;for(let o=0;o<h;o++){for(let a=0;a<s;a++){let u=l.get(r),c=i(a,o,f);ct[r](t,u,c,n)}l.resetAfterLine()}}ce.dataToBitMap=function(e,t){let i=t.width,r=t.height,l=t.depth,n=t.bpp,s=t.interlace,h;l!==8&&(h=_t(e,l));let f;l<=8?f=Buffer.alloc(i*r*4):f=new Uint16Array(i*r*4);let o=Math.pow(2,l)-1,a=0,u,c;if(s)u=ue.getImagePasses(i,r),c=ue.getInterlaceIterator(i,r);else{let p=0;c=function(){let d=p;return p+=4,d},u=[{width:i,height:r}]}for(let p=0;p<u.length;p++)l===8?a=pt(u[p],f,c,n,e,a):dt(u[p],f,c,n,h,o);if(l===8){if(a!==e.length)throw new Error("extra data found")}else h.end();return f}});var W=m((mi,_e)=>{"use strict";function gt(e,t,i,r,l){let n=0;for(let s=0;s<r;s++)for(let h=0;h<i;h++){let f=l[e[n]];if(!f)throw new Error("index "+e[n]+" not in palette");for(let o=0;o<4;o++)t[n+o]=f[o];n+=4}}function yt(e,t,i,r,l){let n=0;for(let s=0;s<r;s++)for(let h=0;h<i;h++){let f=!1;if(l.length===1?l[0]===e[n]&&(f=!0):l[0]===e[n]&&l[1]===e[n+1]&&l[2]===e[n+2]&&(f=!0),f)for(let o=0;o<4;o++)t[n+o]=0;n+=4}}function mt(e,t,i,r,l){let n=255,s=Math.pow(2,l)-1,h=0;for(let f=0;f<r;f++)for(let o=0;o<i;o++){for(let a=0;a<4;a++)t[h+a]=Math.floor(e[h+a]*n/s+.5);h+=4}}_e.exports=function(e,t,i=!1){let r=t.depth,l=t.width,n=t.height,s=t.colorType,h=t.transColor,f=t.palette,o=e;return s===3?gt(e,o,l,n,f):(h&&yt(e,o,l,n,h),r!==8&&!i&&(r===16&&(o=Buffer.alloc(l*n*4)),mt(e,o,l,n,r))),o}});var ge=m((bi,de)=>{"use strict";var bt=require("util"),K=require("zlib"),pe=U(),Et=he(),wt=Z(),Tt=V(),Ct=W(),I=de.exports=function(e){pe.call(this),this._parser=new wt(e,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=e,this.writable=!0,this._parser.start()};bt.inherits(I,pe);I.prototype._handleError=function(e){this.emit("error",e),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",function(){})),this.errord=!0};I.prototype._inflateData=function(e){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=K.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{let i=((this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3)+1)*this._bitmapInfo.height,r=Math.max(i,K.Z_MIN_CHUNK);this._inflate=K.createInflate({chunkSize:r});let l=i,n=this.emit.bind(this,"error");this._inflate.on("error",function(h){!l||n(h)}),this._filter.on("complete",this._complete.bind(this));let s=this._filter.write.bind(this._filter);this._inflate.on("data",function(h){!l||(h.length>l&&(h=h.slice(0,l)),l-=h.length,s(h))}),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(e)};I.prototype._handleMetaData=function(e){this._metaData=e,this._bitmapInfo=Object.create(e),this._filter=new Et(this._bitmapInfo)};I.prototype._handleTransColor=function(e){this._bitmapInfo.transColor=e};I.prototype._handlePalette=function(e){this._bitmapInfo.palette=e};I.prototype._simpleTransparency=function(){this._metaData.alpha=!0};I.prototype._headersFinished=function(){this.emit("metadata",this._metaData)};I.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"))};I.prototype._complete=function(e){if(this.errord)return;let t;try{let i=Tt.dataToBitMap(e,this._bitmapInfo);t=Ct(i,this._bitmapInfo,this._options.skipRescale),i=null}catch(i){this._handleError(i);return}this.emit("parsed",t)}});var me=m((Ei,ye)=>{"use strict";var O=P();ye.exports=function(e,t,i,r){let l=[O.COLORTYPE_COLOR_ALPHA,O.COLORTYPE_ALPHA].indexOf(r.colorType)!==-1;if(r.colorType===r.inputColorType){let d=function(){let y=new ArrayBuffer(2);return new DataView(y).setInt16(0,256,!0),new Int16Array(y)[0]!==256}();if(r.bitDepth===8||r.bitDepth===16&&d)return e}let n=r.bitDepth!==16?e:new Uint16Array(e.buffer),s=255,h=O.COLORTYPE_TO_BPP_MAP[r.inputColorType];h===4&&!r.inputHasAlpha&&(h=3);let f=O.COLORTYPE_TO_BPP_MAP[r.colorType];r.bitDepth===16&&(s=65535,f*=2);let o=Buffer.alloc(t*i*f),a=0,u=0,c=r.bgColor||{};c.red===void 0&&(c.red=s),c.green===void 0&&(c.green=s),c.blue===void 0&&(c.blue=s);function p(){let d,y,_,g=s;switch(r.inputColorType){case O.COLORTYPE_COLOR_ALPHA:g=n[a+3],d=n[a],y=n[a+1],_=n[a+2];break;case O.COLORTYPE_COLOR:d=n[a],y=n[a+1],_=n[a+2];break;case O.COLORTYPE_ALPHA:g=n[a+1],d=n[a],y=d,_=d;break;case O.COLORTYPE_GRAYSCALE:d=n[a],y=d,_=d;break;default:throw new Error("input color type:"+r.inputColorType+" is not supported at present")}return r.inputHasAlpha&&(l||(g/=s,d=Math.min(Math.max(Math.round((1-g)*c.red+g*d),0),s),y=Math.min(Math.max(Math.round((1-g)*c.green+g*y),0),s),_=Math.min(Math.max(Math.round((1-g)*c.blue+g*_),0),s))),{red:d,green:y,blue:_,alpha:g}}for(let d=0;d<i;d++)for(let y=0;y<t;y++){let _=p(n,a);switch(r.colorType){case O.COLORTYPE_COLOR_ALPHA:case O.COLORTYPE_COLOR:r.bitDepth===8?(o[u]=_.red,o[u+1]=_.green,o[u+2]=_.blue,l&&(o[u+3]=_.alpha)):(o.writeUInt16BE(_.red,u),o.writeUInt16BE(_.green,u+2),o.writeUInt16BE(_.blue,u+4),l&&o.writeUInt16BE(_.alpha,u+6));break;case O.COLORTYPE_ALPHA:case O.COLORTYPE_GRAYSCALE:{let g=(_.red+_.green+_.blue)/3;r.bitDepth===8?(o[u]=g,l&&(o[u+1]=_.alpha)):(o.writeUInt16BE(g,u),l&&o.writeUInt16BE(_.alpha,u+2));break}default:throw new Error("unrecognised color Type "+r.colorType)}a+=h,u+=f}return o}});var we=m((wi,Ee)=>{"use strict";var be=v();function Ot(e,t,i,r,l){for(let n=0;n<i;n++)r[l+n]=e[t+n]}function Lt(e,t,i){let r=0,l=t+i;for(let n=t;n<l;n++)r+=Math.abs(e[n]);return r}function It(e,t,i,r,l,n){for(let s=0;s<i;s++){let h=s>=n?e[t+s-n]:0,f=e[t+s]-h;r[l+s]=f}}function kt(e,t,i,r){let l=0;for(let n=0;n<i;n++){let s=n>=r?e[t+n-r]:0,h=e[t+n]-s;l+=Math.abs(h)}return l}function At(e,t,i,r,l){for(let n=0;n<i;n++){let s=t>0?e[t+n-i]:0,h=e[t+n]-s;r[l+n]=h}}function Rt(e,t,i){let r=0,l=t+i;for(let n=t;n<l;n++){let s=t>0?e[n-i]:0,h=e[n]-s;r+=Math.abs(h)}return r}function Bt(e,t,i,r,l,n){for(let s=0;s<i;s++){let h=s>=n?e[t+s-n]:0,f=t>0?e[t+s-i]:0,o=e[t+s]-(h+f>>1);r[l+s]=o}}function Pt(e,t,i,r){let l=0;for(let n=0;n<i;n++){let s=n>=r?e[t+n-r]:0,h=t>0?e[t+n-i]:0,f=e[t+n]-(s+h>>1);l+=Math.abs(f)}return l}function St(e,t,i,r,l,n){for(let s=0;s<i;s++){let h=s>=n?e[t+s-n]:0,f=t>0?e[t+s-i]:0,o=t>0&&s>=n?e[t+s-(i+n)]:0,a=e[t+s]-be(h,f,o);r[l+s]=a}}function Mt(e,t,i,r){let l=0;for(let n=0;n<i;n++){let s=n>=r?e[t+n-r]:0,h=t>0?e[t+n-i]:0,f=t>0&&n>=r?e[t+n-(i+r)]:0,o=e[t+n]-be(s,h,f);l+=Math.abs(o)}return l}var Yt={0:Ot,1:It,2:At,3:Bt,4:St},xt={0:Lt,1:kt,2:Rt,3:Pt,4:Mt};Ee.exports=function(e,t,i,r,l){let n;if(!("filterType"in r)||r.filterType===-1)n=[0,1,2,3,4];else if(typeof r.filterType=="number")n=[r.filterType];else throw new Error("unrecognised filter types");r.bitDepth===16&&(l*=2);let s=t*l,h=0,f=0,o=Buffer.alloc((s+1)*i),a=n[0];for(let u=0;u<i;u++){if(n.length>1){let c=1/0;for(let p=0;p<n.length;p++){let d=xt[n[p]](e,f,s,l);d<c&&(a=n[p],c=d)}}o[h]=a,h++,Yt[a](e,f,s,o,h,l),h+=s,f+=s}return o}});var J=m((Ti,Te)=>{"use strict";var w=P(),qt=j(),Nt=me(),Ut=we(),Ht=require("zlib"),A=Te.exports=function(e){if(this._options=e,e.deflateChunkSize=e.deflateChunkSize||32*1024,e.deflateLevel=e.deflateLevel!=null?e.deflateLevel:9,e.deflateStrategy=e.deflateStrategy!=null?e.deflateStrategy:3,e.inputHasAlpha=e.inputHasAlpha!=null?e.inputHasAlpha:!0,e.deflateFactory=e.deflateFactory||Ht.createDeflate,e.bitDepth=e.bitDepth||8,e.colorType=typeof e.colorType=="number"?e.colorType:w.COLORTYPE_COLOR_ALPHA,e.inputColorType=typeof e.inputColorType=="number"?e.inputColorType:w.COLORTYPE_COLOR_ALPHA,[w.COLORTYPE_GRAYSCALE,w.COLORTYPE_COLOR,w.COLORTYPE_COLOR_ALPHA,w.COLORTYPE_ALPHA].indexOf(e.colorType)===-1)throw new Error("option color type:"+e.colorType+" is not supported at present");if([w.COLORTYPE_GRAYSCALE,w.COLORTYPE_COLOR,w.COLORTYPE_COLOR_ALPHA,w.COLORTYPE_ALPHA].indexOf(e.inputColorType)===-1)throw new Error("option input color type:"+e.inputColorType+" is not supported at present");if(e.bitDepth!==8&&e.bitDepth!==16)throw new Error("option bit depth:"+e.bitDepth+" is not supported at present")};A.prototype.getDeflateOptions=function(){return{chunkSize:this._options.deflateChunkSize,level:this._options.deflateLevel,strategy:this._options.deflateStrategy}};A.prototype.createDeflate=function(){return this._options.deflateFactory(this.getDeflateOptions())};A.prototype.filterData=function(e,t,i){let r=Nt(e,t,i,this._options),l=w.COLORTYPE_TO_BPP_MAP[this._options.colorType];return Ut(r,t,i,this._options,l)};A.prototype._packChunk=function(e,t){let i=t?t.length:0,r=Buffer.alloc(i+12);return r.writeUInt32BE(i,0),r.writeUInt32BE(e,4),t&&t.copy(r,8),r.writeInt32BE(qt.crc32(r.slice(4,r.length-4)),r.length-4),r};A.prototype.packGAMA=function(e){let t=Buffer.alloc(4);return t.writeUInt32BE(Math.floor(e*w.GAMMA_DIVISION),0),this._packChunk(w.TYPE_gAMA,t)};A.prototype.packIHDR=function(e,t){let i=Buffer.alloc(13);return i.writeUInt32BE(e,0),i.writeUInt32BE(t,4),i[8]=this._options.bitDepth,i[9]=this._options.colorType,i[10]=0,i[11]=0,i[12]=0,this._packChunk(w.TYPE_IHDR,i)};A.prototype.packIDAT=function(e){return this._packChunk(w.TYPE_IDAT,e)};A.prototype.packIEND=function(){return this._packChunk(w.TYPE_IEND,null)}});var Ie=m((Ci,Le)=>{"use strict";var Dt=require("util"),Ce=require("stream"),vt=P(),Gt=J(),Oe=Le.exports=function(e){Ce.call(this);let t=e||{};this._packer=new Gt(t),this._deflate=this._packer.createDeflate(),this.readable=!0};Dt.inherits(Oe,Ce);Oe.prototype.pack=function(e,t,i,r){this.emit("data",Buffer.from(vt.PNG_SIGNATURE)),this.emit("data",this._packer.packIHDR(t,i)),r&&this.emit("data",this._packer.packGAMA(r));let l=this._packer.filterData(e,t,i);this._deflate.on("error",this.emit.bind(this,"error")),this._deflate.on("data",function(n){this.emit("data",this._packer.packIDAT(n))}.bind(this)),this._deflate.on("end",function(){this.emit("data",this._packer.packIEND()),this.emit("end")}.bind(this)),this._deflate.end(l)}});var Se=m((M,Pe)=>{"use strict";var ke=require("assert").ok,S=require("zlib"),Ft=require("util"),Ae=require("buffer").kMaxLength;function R(e){if(!(this instanceof R))return new R(e);e&&e.chunkSize<S.Z_MIN_CHUNK&&(e.chunkSize=S.Z_MIN_CHUNK),S.Inflate.call(this,e),this._offset=this._offset===void 0?this._outOffset:this._offset,this._buffer=this._buffer||this._outBuffer,e&&e.maxLength!=null&&(this._maxLength=e.maxLength)}function zt(e){return new R(e)}function Re(e,t){t&&process.nextTick(t),e._handle&&(e._handle.close(),e._handle=null)}R.prototype._processChunk=function(e,t,i){if(typeof i=="function")return S.Inflate._processChunk.call(this,e,t,i);let r=this,l=e&&e.length,n=this._chunkSize-this._offset,s=this._maxLength,h=0,f=[],o=0,a;this.on("error",function(d){a=d});function u(d,y){if(r._hadError)return;let _=n-y;if(ke(_>=0,"have should not go down"),_>0){let g=r._buffer.slice(r._offset,r._offset+_);if(r._offset+=_,g.length>s&&(g=g.slice(0,s)),f.push(g),o+=g.length,s-=g.length,s===0)return!1}return(y===0||r._offset>=r._chunkSize)&&(n=r._chunkSize,r._offset=0,r._buffer=Buffer.allocUnsafe(r._chunkSize)),y===0?(h+=l-d,l=d,!0):!1}ke(this._handle,"zlib binding closed");let c;do c=this._handle.writeSync(t,e,h,l,this._buffer,this._offset,n),c=c||this._writeState;while(!this._hadError&&u(c[0],c[1]));if(this._hadError)throw a;if(o>=Ae)throw Re(this),new RangeError("Cannot create final Buffer. It would be larger than 0x"+Ae.toString(16)+" bytes");let p=Buffer.concat(f,o);return Re(this),p};Ft.inherits(R,S.Inflate);function jt(e,t){if(typeof t=="string"&&(t=Buffer.from(t)),!(t instanceof Buffer))throw new TypeError("Not a string or buffer");let i=e._finishFlushFlag;return i==null&&(i=S.Z_FINISH),e._processChunk(t,i)}function Be(e,t){return jt(new R(t),e)}Pe.exports=M=Be;M.Inflate=R;M.createInflate=zt;M.inflateSync=Be});var Q=m((Oi,Ye)=>{"use strict";var Me=Ye.exports=function(e){this._buffer=e,this._reads=[]};Me.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t})};Me.prototype.process=function(){for(;this._reads.length>0&&this._buffer.length;){let e=this._reads[0];if(this._buffer.length&&(this._buffer.length>=e.length||e.allowLess)){this._reads.shift();let t=this._buffer;this._buffer=t.slice(e.length),e.func.call(this,t.slice(0,e.length))}else break}if(this._reads.length>0)throw new Error("There are some read requests waitng on finished stream");if(this._buffer.length>0)throw new Error("unrecognised content at end of stream")}});var qe=m(xe=>{"use strict";var Zt=Q(),Vt=G();xe.process=function(e,t){let i=[],r=new Zt(e);return new Vt(t,{read:r.read.bind(r),write:function(n){i.push(n)},complete:function(){}}).start(),r.process(),Buffer.concat(i)}});var De=m((Ii,He)=>{"use strict";var Ne=!0,Ue=require("zlib"),Wt=Se();Ue.deflateSync||(Ne=!1);var Kt=Q(),Jt=qe(),Qt=Z(),$t=V(),Xt=W();He.exports=function(e,t){if(!Ne)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let i;function r(C){i=C}let l;function n(C){l=C}function s(C){l.transColor=C}function h(C){l.palette=C}function f(){l.alpha=!0}let o;function a(C){o=C}let u=[];function c(C){u.push(C)}let p=new Kt(e);if(new Qt(t,{read:p.read.bind(p),error:r,metadata:n,gamma:a,palette:h,transColor:s,inflateData:c,simpleTransparency:f}).start(),p.process(),i)throw i;let y=Buffer.concat(u);u.length=0;let _;if(l.interlace)_=Ue.inflateSync(y);else{let X=((l.width*l.bpp*l.depth+7>>3)+1)*l.height;_=Wt(y,{chunkSize:X,maxLength:X})}if(y=null,!_||!_.length)throw new Error("bad png - invalid inflate data response");let g=Jt.process(_,l);y=null;let Ke=$t.dataToBitMap(g,l);g=null;let Je=Xt(Ke,l,t.skipRescale);return l.data=Je,l.gamma=o||0,l}});var ze=m((ki,Fe)=>{"use strict";var ve=!0,Ge=require("zlib");Ge.deflateSync||(ve=!1);var ei=P(),ti=J();Fe.exports=function(e,t){if(!ve)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let i=t||{},r=new ti(i),l=[];l.push(Buffer.from(ei.PNG_SIGNATURE)),l.push(r.packIHDR(e.width,e.height)),e.gamma&&l.push(r.packGAMA(e.gamma));let n=r.filterData(e.data,e.width,e.height),s=Ge.deflateSync(n,r.getDeflateOptions());if(n=null,!s||!s.length)throw new Error("bad png - invalid compressed data response");return l.push(r.packIDAT(s)),l.push(r.packIEND()),Buffer.concat(l)}});var je=m($=>{"use strict";var ii=De(),ri=ze();$.read=function(e,t){return ii(e,t||{})};$.write=function(e,t){return ri(e,t)}});var We=m(Ve=>{"use strict";var ni=require("util"),Ze=require("stream"),li=ge(),si=Ie(),hi=je(),T=Ve.PNG=function(e){Ze.call(this),e=e||{},this.width=e.width|0,this.height=e.height|0,this.data=this.width>0&&this.height>0?Buffer.alloc(4*this.width*this.height):null,e.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new li(e),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(t){this.data=t,this.emit("parsed",t)}.bind(this)),this._packer=new si(e),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};ni.inherits(T,Ze);T.sync=hi;T.prototype.pack=function(){return!this.data||!this.data.length?(this.emit("error","No data provided"),this):(process.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this)};T.prototype.parse=function(e,t){if(t){let i,r;i=function(l){this.removeListener("error",r),this.data=l,t(null,this)}.bind(this),r=function(l){this.removeListener("parsed",i),t(l,null)}.bind(this),this.once("parsed",i),this.once("error",r)}return this.end(e),this};T.prototype.write=function(e){return this._parser.write(e),!0};T.prototype.end=function(e){this._parser.end(e)};T.prototype._metadata=function(e){this.width=e.width,this.height=e.height,this.emit("metadata",e)};T.prototype._gamma=function(e){this.gamma=e};T.prototype._handleClose=function(){!this._parser.writable&&!this._packer.readable&&this.emit("close")};T.bitblt=function(e,t,i,r,l,n,s,h){if(i|=0,r|=0,l|=0,n|=0,s|=0,h|=0,i>e.width||r>e.height||i+l>e.width||r+n>e.height)throw new Error("bitblt reading outside image");if(s>t.width||h>t.height||s+l>t.width||h+n>t.height)throw new Error("bitblt writing outside image");for(let f=0;f<n;f++)e.data.copy(t.data,(h+f)*t.width+s<<2,(r+f)*e.width+i<<2,(r+f)*e.width+i+l<<2)};T.prototype.bitblt=function(e,t,i,r,l,n,s){return T.bitblt(this,e,t,i,r,l,n,s),this};T.adjustGamma=function(e){if(e.gamma){for(let t=0;t<e.height;t++)for(let i=0;i<e.width;i++){let r=e.width*t+i<<2;for(let l=0;l<3;l++){let n=e.data[r+l]/255;n=Math.pow(n,1/2.2/e.gamma),e.data[r+l]=Math.round(n*255)}}e.gamma=0}};T.prototype.adjustGamma=function(){T.adjustGamma(this)}});var x={};module.exports=rt(x);N(x,it(We()),module.exports);
